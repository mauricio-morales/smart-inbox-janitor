<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:TransMailPanda.ViewModels"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="600" d:DesignHeight="500"
        x:Class="TransMailPanda.Views.WelcomeWizardWindow"
        x:DataType="vm:WelcomeWizardViewModel"
        Title="TransMail Panda Setup"
        Width="600" Height="500"
        CanResize="False"
        WindowStartupLocation="CenterScreen"
        Icon="/Assets/avalonia-logo.ico">

    <Design.DataContext>
        <vm:WelcomeWizardViewModel/>
    </Design.DataContext>

    <Grid Margin="40">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="15" Margin="0,0,0,30">
            <!-- Logo/Icon placeholder -->
            <Border Background="#4CAF50" Width="50" Height="50" CornerRadius="25">
                <TextBlock Text="ðŸ¼" FontSize="24" HorizontalAlignment="Center" VerticalAlignment="Center"/>
            </Border>
            <StackPanel VerticalAlignment="Center">
                <TextBlock Text="TransMail Panda" FontSize="24" FontWeight="Bold"/>
                <TextBlock Text="Email Cleanup Assistant" FontSize="14" Foreground="Gray"/>
            </StackPanel>
        </StackPanel>

        <!-- Content Area -->
        <ScrollViewer Grid.Row="1">
            
            <!-- Gmail Sign-in Step -->
            <StackPanel IsVisible="{Binding IsGmailStep}" Spacing="20">
                <TextBlock Text="{Binding GmailStepTitle}" FontSize="20" FontWeight="SemiBold"/>
                <TextBlock Text="{Binding GmailStepMessage}" FontSize="14" TextWrapping="Wrap" Foreground="Gray"/>
                
                <Border Background="#F5F5F5" Padding="20" CornerRadius="8">
                    <StackPanel Spacing="15">
                        <!-- Gmail Connection Status -->
                        <StackPanel IsVisible="{Binding IsGmailConnected}" Spacing="10">
                            <StackPanel Orientation="Horizontal" Spacing="10">
                                <TextBlock Text="âœ…" FontSize="16"/>
                                <TextBlock Text="Connected to Gmail:" FontWeight="SemiBold"/>
                            </StackPanel>
                            <TextBlock Text="{Binding GmailAccountEmail}" FontSize="14" Margin="26,0,0,0"/>
                        </StackPanel>

                        <!-- Gmail Connect Button -->
                        <Button 
                            Command="{Binding ConnectGmailCommand}"
                            IsEnabled="{Binding !IsLoading}"
                            IsVisible="{Binding !IsGmailConnected}"
                            HorizontalAlignment="Left"
                            Padding="20,12"
                            Classes="accent">
                            <StackPanel Orientation="Horizontal" Spacing="10">
                                <TextBlock Text="ðŸ“§" FontSize="16"/>
                                <TextBlock Text="Connect Gmail Account"/>
                            </StackPanel>
                        </Button>

                        <!-- Status Message -->
                        <TextBlock 
                            Text="{Binding StatusMessage}" 
                            IsVisible="{Binding !!StatusMessage}"
                            FontSize="12"
                            TextWrapping="Wrap"/>
                    </StackPanel>
                </Border>
            </StackPanel>

            <!-- OpenAI Setup Step -->
            <StackPanel IsVisible="{Binding IsOpenAiStep}" Spacing="20">
                <TextBlock Text="{Binding OpenAiStepTitle}" FontSize="20" FontWeight="SemiBold"/>
                <TextBlock Text="{Binding OpenAiStepMessage}" FontSize="14" TextWrapping="Wrap" Foreground="Gray"/>
                
                <Border Background="#F5F5F5" Padding="20" CornerRadius="8">
                    <StackPanel Spacing="15">
                        
                        <!-- Step-by-step guide -->
                        <StackPanel Spacing="10">
                            <TextBlock Text="Step 1: Get your OpenAI API Key" FontWeight="SemiBold"/>
                            <TextBlock Text="â€¢ Create an account at platform.openai.com (if you don't have one)" FontSize="12" Margin="10,0"/>
                            <TextBlock Text="â€¢ Go to API Keys section" FontSize="12" Margin="10,0"/>
                            <TextBlock Text="â€¢ Click 'Create new secret key'" FontSize="12" Margin="10,0"/>
                            <TextBlock Text="â€¢ Copy the key that starts with 'sk-'" FontSize="12" Margin="10,0"/>
                            
                            <Button 
                                Command="{Binding OpenOpenAiDashboardCommand}"
                                Margin="10,5,0,0"
                                HorizontalAlignment="Left"
                                Padding="15,8">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <TextBlock Text="ðŸ”—" FontSize="14"/>
                                    <TextBlock Text="Open OpenAI Dashboard"/>
                                </StackPanel>
                            </Button>
                        </StackPanel>

                        <Separator/>

                        <!-- API Key Input -->
                        <StackPanel Spacing="10">
                            <TextBlock Text="Step 2: Enter your API Key" FontWeight="SemiBold"/>
                            
                            <!-- Connection Status -->
                            <StackPanel IsVisible="{Binding IsOpenAiConfigured}" Spacing="5">
                                <StackPanel Orientation="Horizontal" Spacing="10">
                                    <TextBlock Text="âœ…" FontSize="16"/>
                                    <TextBlock Text="OpenAI API Key configured" FontWeight="SemiBold"/>
                                </StackPanel>
                                <TextBlock Text="{Binding OpenAiKeyLastFour, StringFormat='Key ending in: ...{0}'}" 
                                          FontSize="12" Margin="26,0,0,0" Foreground="Gray"/>
                            </StackPanel>

                            <!-- Input for API Key -->
                            <StackPanel IsVisible="{Binding !IsOpenAiConfigured}" Spacing="10">
                                <TextBox 
                                    Text="{Binding OpenAiApiKey}"
                                    Watermark="sk-..."
                                    PasswordChar="*"
                                    UseFloatingWatermark="True"
                                    Width="300"
                                    HorizontalAlignment="Left"/>
                                
                                <Button 
                                    Command="{Binding TestOpenAiConnectionCommand}"
                                    IsEnabled="{Binding !IsLoading}"
                                    HorizontalAlignment="Left"
                                    Padding="15,10"
                                    Classes="accent">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <TextBlock Text="ðŸ§ª" FontSize="14"/>
                                        <TextBlock Text="Test Connection"/>
                                    </StackPanel>
                                </Button>
                            </StackPanel>

                            <!-- Cost Information -->
                            <Border Background="#E8F5E8" Padding="12" CornerRadius="4" Margin="0,10,0,0">
                                <StackPanel Spacing="5">
                                    <TextBlock Text="ðŸ’° Estimated Costs" FontWeight="SemiBold" FontSize="12"/>
                                    <TextBlock Text="â€¢ Typical cleanup: $1-5 total cost" FontSize="11" Foreground="DarkGreen"/>
                                    <TextBlock Text="â€¢ Cost depends on number of emails processed" FontSize="11" Foreground="DarkGreen"/>
                                    <TextBlock Text="â€¢ You're always in control of spending" FontSize="11" Foreground="DarkGreen"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>

                        <!-- Status Message -->
                        <TextBlock 
                            Text="{Binding StatusMessage}" 
                            IsVisible="{Binding !!StatusMessage}"
                            FontSize="12"
                            TextWrapping="Wrap"/>
                    </StackPanel>
                </Border>
            </StackPanel>

            <!-- Ready Step -->
            <StackPanel IsVisible="{Binding IsReadyStep}" Spacing="20">
                <TextBlock Text="{Binding ReadyTitle}" FontSize="20" FontWeight="SemiBold"/>
                <TextBlock Text="{Binding ReadyMessage}" FontSize="14" TextWrapping="Wrap" Foreground="Gray"/>
                
                <Border Background="#E8F5E8" Padding="20" CornerRadius="8">
                    <StackPanel Spacing="15">
                        <StackPanel Orientation="Horizontal" Spacing="10">
                            <TextBlock Text="ðŸŽ‰" FontSize="24"/>
                            <TextBlock Text="Setup Complete!" FontSize="18" FontWeight="SemiBold" VerticalAlignment="Center"/>
                        </StackPanel>
                        
                        <StackPanel Spacing="8">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Text="âœ…" FontSize="14"/>
                                <TextBlock Text="Gmail connected" FontSize="14"/>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Text="âœ…" FontSize="14"/>
                                <TextBlock Text="AI assistant configured" FontSize="14"/>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Text="âœ…" FontSize="14"/>
                                <TextBlock Text="Ready to clean your inbox!" FontSize="14"/>
                            </StackPanel>
                        </StackPanel>

                        <TextBlock 
                            Text="{Binding StatusMessage}"
                            FontSize="12"
                            TextWrapping="Wrap"
                            Margin="0,10,0,0"/>
                    </StackPanel>
                </Border>
            </StackPanel>

        </ScrollViewer>

        <!-- Footer Navigation -->
        <Grid Grid.Row="2" Margin="0,20,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- Loading Indicator -->
            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="10" VerticalAlignment="Center">
                <Border IsVisible="{Binding IsLoading}" 
                        Width="16" Height="16" 
                        Background="Gray" 
                        CornerRadius="8"
                        Classes="loading"/>
                <TextBlock IsVisible="{Binding IsLoading}" 
                          Text="Loading..." 
                          FontSize="12" 
                          Foreground="Gray"/>
            </StackPanel>

            <!-- Navigation Buttons -->
            <Button Grid.Column="1" 
                    Command="{Binding PreviousStepCommand}"
                    IsVisible="{Binding !IsWelcomeStep}"
                    Margin="0,0,10,0"
                    Padding="15,10">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="â†" FontSize="14"/>
                    <TextBlock Text="Back"/>
                </StackPanel>
            </Button>

            <!-- Next/Finish Button -->
            <Button Grid.Column="2" 
                    Classes="accent"
                    IsEnabled="{Binding CanProceedToNext}"
                    Padding="15,10">
                <Button.Command>
                    <MultiBinding Converter="{x:Static BoolConverters.Or}">
                        <Binding Path="NextStepCommand"/>
                        <Binding Path="FinishSetupCommand"/>
                    </MultiBinding>
                </Button.Command>
                
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock>
                        <TextBlock.Text>
                            <MultiBinding StringFormat="">
                                <Binding Path="IsReadyStep"/>
                            </MultiBinding>
                        </TextBlock.Text>
                    </TextBlock>
                    <TextBlock Text="{Binding IsReadyStep, Converter={x:Static ObjectConverters.IsEqual}, ConverterParameter={x:True}, FallbackValue='Next â†’'}">
                        <TextBlock.Text>
                            <MultiBinding Converter="{x:Static StringConverters.SelectMany}">
                                <Binding Source="Start Using TransMail Panda"/>
                                <Binding Source="Next â†’"/>
                                <Binding Path="IsReadyStep"/>
                            </MultiBinding>
                        </TextBlock.Text>
                    </TextBlock>
                </StackPanel>
            </Button>
        </Grid>
    </Grid>

    <!-- Styles -->
    <Window.Styles>
        <Style Selector="Button.accent">
            <Setter Property="Background" Value="#4CAF50"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="CornerRadius" Value="6"/>
        </Style>
        
        <Style Selector="Button.accent:pointerover">
            <Setter Property="Background" Value="#45A049"/>
        </Style>

        <Style Selector="Border.loading">
            <Style.Animations>
                <Animation Duration="0:0:1" IterationCount="Infinite">
                    <KeyFrame Cue="0%">
                        <Setter Property="Opacity" Value="1.0"/>
                    </KeyFrame>
                    <KeyFrame Cue="50%">
                        <Setter Property="Opacity" Value="0.3"/>
                    </KeyFrame>
                    <KeyFrame Cue="100%">
                        <Setter Property="Opacity" Value="1.0"/>
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>
    </Window.Styles>
</Window>