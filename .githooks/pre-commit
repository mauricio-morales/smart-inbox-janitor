#!/bin/bash

# Pre-commit hook to run dotnet format
# This ensures all commits have properly formatted code

echo "Running dotnet format before commit..."

# Run dotnet format (whitespace, style, and analyzers) and check if any files were changed
dotnet format whitespace --include-generated --verbosity diagnostic
dotnet_whitespace_exit=$?

dotnet format style --include-generated --verbosity diagnostic  
dotnet_style_exit=$?

dotnet format analyzers --include-generated --verbosity diagnostic
dotnet_analyzers_exit=$?

# Check if any dotnet format commands failed
if [ $dotnet_whitespace_exit -ne 0 ] || [ $dotnet_style_exit -ne 0 ] || [ $dotnet_analyzers_exit -ne 0 ]; then
    echo "Error: dotnet format failed. Please fix formatting issues and try again."
    echo "Exit codes - whitespace: $dotnet_whitespace_exit, style: $dotnet_style_exit, analyzers: $dotnet_analyzers_exit"
    exit 1
fi

# Check if any files were modified by dotnet format
if ! git diff --quiet; then
    echo "Files were formatted by dotnet format. Please stage the changes and commit again."
    echo "Changed files:"
    git diff --name-only
    exit 1
fi

echo "Code formatting check passed."
exit 0